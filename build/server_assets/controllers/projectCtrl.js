'use strict';

var mongoose = require('mongoose');
var Project = require('../models/Project.js');
var ProjectTask = require('../models/ProjectTask.js');
var Template = require('../models/Template');
var TemplateTask = require('../models/TemplateTask.js');
var timeCtrl = require('../controllers/timeCtrl');
var helpers = require('../controllers/projectHelpers');
var _ = require('underscore');
var Q = require('q');
var randomstring = require('randomstring');
var Employee = require('../models/Employee.js');

module.exports = {
  endpointProject: function endpointProject(req, res) {
    var templateId = req.params.templateid;
    var instance = req.body.instance;
    var description = req.body.description;
    module.exports.newProject(templateId, description, instance).then(function (project) {
      return res.json(project);
    });
  },
  newProject: function newProject(templateId, description, instance) {
    console.log("#1 - New Project Function Called");
    var deferred = Q.defer();
    var associatedProjectId;
    var newProject;
    helpers.makeProjectObject(templateId).then(function (cleanObject) {
      console.log("#3 - Make Project Object Returned: ", cleanObject);
      newProject = new Project(cleanObject);
      newProject.friendlyId = randomstring.generate({ length: 5, readable: true });
      console.log("#4 - New Project Id : ", newProject._id);
      associatedProjectId = newProject._id;
      console.log("#5 - associatedProjectId :", associatedProjectId);
      return helpers.nextOccurrence(cleanObject, instance);
    }).then(function (deadline) {
      console.log("#14 - Next Occurance Returned: ", deadline);
      newProject.setup.dueDate.actual = deadline;
      console.log("#15 - New Project Deadline Set : ", newProject.setup.dueDate.actual);
      return helpers.getTaskArray(templateId);
    }).then(function (arrayofIds) {
      console.log("#17 - Returned From Task Array Helper ", arrayofIds);
      //for every id, make a new project task
      var new_tasks_promises = _.map(arrayofIds, function (id) {
        console.log("Array of Ids ID ", id);
        return helpers.makeTemplateTaskObject(id, associatedProjectId);
      });
      //new_tasks_promises now contains an array of promises which will be resolved as each of the tasks are created
      console.log("#19 - Array of New Task Promises", new_tasks_promises);
      return Q.all(new_tasks_promises);
    }).then(function (clean_objects) {
      console.log("#20 - Array of New Task Objects", clean_objects);
      return Q.all(_.map(clean_objects, function (clean_object) {
        return helpers.makeProjectTask(clean_object, associatedProjectId);
      }));
    }).then(function (project_tasks) {
      console.log("#22 - Project Tasks", project_tasks);
      //take tasks, put in Project, save
      newProject.description = description;
      for (var i = 0; i < project_tasks.length; i++) {
        newProject.tasks.push(project_tasks[i]);
      }
      newProject.setup.associatedTemplate = templateId;
      newProject.save().then(function (project) {
        console.log("Made it!");
        deferred.resolve(project);
      });
    });
    return deferred.promise;
  },
  newSingleProject: function newSingleProject(req, res) {
    var newProject = new Project(req.body);
    newProject.friendlyId = randomstring.generate({ length: 5, readable: true });
    newProject.save().then(function (project) {
      return res.json(project);
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  newTriggeredProject: function newTriggeredProject(req, res) {
    console.log("#1 - New Project Function Called");
    var templateId = req.params.templateid;
    var instance = req.body.instance;
    var description = req.body.description;
    var associatedProjectId;
    var newProject;
    helpers.makeProjectObject(templateId).then(function (cleanObject) {
      console.log("#3 - Make Project Object Returned: ", cleanObject);
      newProject = new Project(cleanObject);
      newProject.friendlyId = randomstring.generate({ length: 5, readable: true });
      console.log("#4 - New Project Id : ", newProject._id);
      associatedProjectId = newProject._id;
      console.log("#5 - associatedProjectId :", associatedProjectId);
      return timeCtrl.triggeredProjectDeadline();
    }).then(function (deadline) {
      console.log("#14 - Next Occurance Returned: ", deadline);
      newProject.setup.dueDate.actual = deadline;
      console.log("#15 - New Project Deadline Set : ", newProject.setup.dueDate.actual);
      return helpers.getTaskArray(templateId);
    }).then(function (arrayofIds) {
      console.log("#17 - Returned From Task Array Helper ", arrayofIds);
      //for every id, make a new project task
      var new_tasks_promises = _.map(arrayofIds, function (id) {
        console.log("Array of Ids ID ", id);
        return helpers.makeTemplateTaskObject(id, associatedProjectId);
      });
      //new_tasks_promises now contains an array of promises which will be resolved as each of the tasks are created
      console.log("#19 - Array of New Task Promises", new_tasks_promises);
      return Q.all(new_tasks_promises);
    }).then(function (clean_objects) {
      console.log("#20 - Array of New Task Objects", clean_objects);
      return Q.all(_.map(clean_objects, function (clean_object) {
        return helpers.makeProjectTask(clean_object, associatedProjectId);
      }));
    }).then(function (project_tasks) {
      console.log("#22 - Project Tasks", project_tasks);
      //take tasks, put in Project, save
      newProject.description = description;
      for (var i = 0; i < project_tasks.length; i++) {
        newProject.tasks.push(project_tasks[i]);
      }
      newProject.save().then(function (project) {
        console.log("Made it!");
        return res.json(project);
      });
    });
  },
  oneProject: function oneProject(req, res) {
    var templateOptions = {
      path: 'tasks',
      model: 'ProjectTask',
      populate: {
        path: "assignment.employees",
        model: "Employee",
        select: "identification.name.fullName"
      }
    };
    Project.findById(req.params.id).populate(templateOptions).exec().then(function (result) {
      return res.json(result);
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  editProject: function editProject(req, res) {
    Project.update({ _id: req.params.id }, req.body).then(function () {
      return res.status(200).end();
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  deleteProject: function deleteProject(req, res) {
    Project.remove({ _id: req.params.id }, req.body).then(function () {
      return res.status(200).end();
    }).catch(function (err) {
      return res.status(500).end();
    });
  },
  allProjects: function allProjects(req, res) {
    Project.find().populate('tasks').exec().then(function (result) {
      return res.json(result);
    }).catch(function (err) {
      return res.status(500).end();
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlcl9hc3NldHMvY29udHJvbGxlcnMvcHJvamVjdEN0cmwuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFNLFdBQVcsUUFBUSxVQUFSLENBQVg7QUFDTixJQUFNLFVBQVUsUUFBUSxzQkFBUixDQUFWO0FBQ04sSUFBTSxjQUFjLFFBQVEsMEJBQVIsQ0FBZDtBQUNOLElBQU0sV0FBVyxRQUFRLG9CQUFSLENBQVg7QUFDTixJQUFNLGVBQWUsUUFBUSwyQkFBUixDQUFmO0FBQ04sSUFBTSxXQUFXLFFBQVEseUJBQVIsQ0FBWDtBQUNOLElBQU0sVUFBVSxRQUFRLCtCQUFSLENBQVY7QUFDTixJQUFNLElBQUksUUFBUSxZQUFSLENBQUo7QUFDTixJQUFNLElBQUksUUFBUSxHQUFSLENBQUo7QUFDTixJQUFNLGVBQWUsUUFBUSxjQUFSLENBQWY7QUFDTixJQUFNLFdBQVcsUUFBUSx1QkFBUixDQUFYOztBQUdOLE9BQU8sT0FBUCxHQUFpQjtBQUViLDRDQUFnQixLQUFLLEtBQUs7QUFDdEIsUUFBSSxhQUFhLElBQUksTUFBSixDQUFXLFVBQVgsQ0FESztBQUV0QixRQUFJLFdBQVcsSUFBSSxJQUFKLENBQVMsUUFBVCxDQUZPO0FBR3RCLFFBQUksY0FBYyxJQUFJLElBQUosQ0FBUyxXQUFULENBSEk7QUFJdEIsV0FBTyxPQUFQLENBQWUsVUFBZixDQUEwQixVQUExQixFQUFzQyxXQUF0QyxFQUFtRCxRQUFuRCxFQUNDLElBREQsQ0FDTSxVQUFDLE9BQUQsRUFBYTtBQUNmLGFBQU8sSUFBSSxJQUFKLENBQVMsT0FBVCxDQUFQLENBRGU7S0FBYixDQUROLENBSnNCO0dBRmI7QUFZZixrQ0FBVyxZQUFZLGFBQVksVUFBVTtBQUMzQyxZQUFRLEdBQVIsQ0FBWSxrQ0FBWixFQUQyQztBQUUzQyxRQUFJLFdBQVcsRUFBRSxLQUFGLEVBQVgsQ0FGdUM7QUFHM0MsUUFBSSxtQkFBSixDQUgyQztBQUkzQyxRQUFJLFVBQUosQ0FKMkM7QUFLM0MsWUFB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LElBQUksTUFBSixDQUFXLEVBQVgsRUFBckIsRUFBcUMsSUFBSSxJQUFKLENBQXJDLENBQStDLElBQS9DLENBQW9ELFlBQU07QUFDeEQsYUFBTyxJQUFJLE1BQUosQ0FBVyxHQUFYLEVBQWdCLEdBQWhCLEVBQVAsQ0FEd0Q7S0FBTixDQUFwRCxDQUVHLEtBRkgsQ0FFUyxVQUFDLEdBQUQsRUFBUztBQUNoQixhQUFPLElBQUksTUFBSixDQUFXLEdBQVgsRUFBZ0IsR0FBaEIsRUFBUCxDQURnQjtLQUFULENBRlQsQ0FEb0I7R0FwSlA7QUE0SmYsd0NBQWMsS0FBSyxLQUFLO0FBQ3RCLFlBQVEsTUFBUixDQUFlLEVBQUMsS0FBSyxJQUFJLE1BQUosQ0FBVyxFQUFYLEVBQXJCLEVBQXFDLElBQUksSUFBSixDQUFyQyxDQUErQyxJQUEvQyxDQUFvRCxZQUFNO0FBQ3hELGFBQU8sSUFBSSxNQUFKLENBQVcsR0FBWCxFQUFnQixHQUFoQixFQUFQLENBRHdEO0tBQU4sQ0FBcEQsQ0FFRyxLQUZILENBRVMsVUFBQyxHQUFELEVBQVM7QUFDaEIsYUFBTyxJQUFJLE1BQUosQ0FBVyxHQUFYLEVBQWdCLEdBQWhCLEVBQVAsQ0FEZ0I7S0FBVCxDQUZULENBRHNCO0dBNUpUO0FBcUtmLG9DQUFZLEtBQUssS0FBSztBQUNwQixZQUFRLElBQVIsR0FBZSxRQUFmLENBQXdCLE9BQXhCLEVBQWlDLElBQWpDLEdBQXdDLElBQXhDLENBQTZDLFVBQUMsTUFBRCxFQUFZO0FBQ3ZELGFBQU8sSUFBSSxJQUFKLENBQVMsTUFBVCxDQUFQLENBRHVEO0tBQVosQ0FBN0MsQ0FFRyxLQUZILENBRVMsVUFBQyxHQUFELEVBQVM7QUFDaEIsYUFBTyxJQUFJLE1BQUosQ0FBVyxHQUFYLEVBQWdCLEdBQWhCLEVBQVAsQ0FEZ0I7S0FBVCxDQUZULENBRG9CO0dBcktQO0NBQWpCIiwiZmlsZSI6InNlcnZlcl9hc3NldHMvY29udHJvbGxlcnMvcHJvamVjdEN0cmwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XHJcbmNvbnN0IFByb2plY3QgPSByZXF1aXJlKCcuLi9tb2RlbHMvUHJvamVjdC5qcycpO1xyXG5jb25zdCBQcm9qZWN0VGFzayA9IHJlcXVpcmUoJy4uL21vZGVscy9Qcm9qZWN0VGFzay5qcycpO1xyXG5jb25zdCBUZW1wbGF0ZSA9IHJlcXVpcmUoJy4uL21vZGVscy9UZW1wbGF0ZScpO1xyXG5jb25zdCBUZW1wbGF0ZVRhc2sgPSByZXF1aXJlKCcuLi9tb2RlbHMvVGVtcGxhdGVUYXNrLmpzJyk7XHJcbmNvbnN0IHRpbWVDdHJsID0gcmVxdWlyZSgnLi4vY29udHJvbGxlcnMvdGltZUN0cmwnKTtcclxuY29uc3QgaGVscGVycyA9IHJlcXVpcmUoJy4uL2NvbnRyb2xsZXJzL3Byb2plY3RIZWxwZXJzJyk7XHJcbmNvbnN0IF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7XHJcbmNvbnN0IFEgPSByZXF1aXJlKCdxJyk7XHJcbmNvbnN0IHJhbmRvbXN0cmluZyA9IHJlcXVpcmUoJ3JhbmRvbXN0cmluZycpO1xyXG5jb25zdCBFbXBsb3llZSA9IHJlcXVpcmUoJy4uL21vZGVscy9FbXBsb3llZS5qcycpO1xyXG5cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG5cclxuICAgIGVuZHBvaW50UHJvamVjdChyZXEsIHJlcykge1xyXG4gICAgICAgIHZhciB0ZW1wbGF0ZUlkID0gcmVxLnBhcmFtcy50ZW1wbGF0ZWlkO1xyXG4gICAgICAgIHZhciBpbnN0YW5jZSA9IHJlcS5ib2R5Lmluc3RhbmNlO1xyXG4gICAgICAgIHZhciBkZXNjcmlwdGlvbiA9IHJlcS5ib2R5LmRlc2NyaXB0aW9uO1xyXG4gICAgICAgIG1vZHVsZS5leHBvcnRzLm5ld1Byb2plY3QodGVtcGxhdGVJZCwgZGVzY3JpcHRpb24sIGluc3RhbmNlKVxyXG4gICAgICAgIC50aGVuKChwcm9qZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuanNvbihwcm9qZWN0KTtcclxuICAgICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gIG5ld1Byb2plY3QodGVtcGxhdGVJZCwgZGVzY3JpcHRpb24saW5zdGFuY2UpIHtcclxuICAgIGNvbnNvbGUubG9nKFwiIzEgLSBOZXcgUHJvamVjdCBGdW5jdGlvbiBDYWxsZWRcIik7XHJcbiAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XHJcbiAgICB2YXIgYXNzb2NpYXRlZFByb2plY3RJZDtcclxuICAgIHZhciBuZXdQcm9qZWN0O1xyXG4gICAgaGVscGVycy5tYWtlUHJvamVjdE9iamVjdCh0ZW1wbGF0ZUlkKVxyXG4gICAgICAudGhlbigoY2xlYW5PYmplY3QpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIiMzIC0gTWFrZSBQcm9qZWN0IE9iamVjdCBSZXR1cm5lZDogXCIsIGNsZWFuT2JqZWN0KTtcclxuICAgICAgICBuZXdQcm9qZWN0ID0gbmV3IFByb2plY3QoY2xlYW5PYmplY3QpO1xyXG4gICAgICAgIG5ld1Byb2plY3QuZnJpZW5kbHlJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7bGVuZ3RoOiA1LCByZWFkYWJsZTogdHJ1ZX0pO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzQgLSBOZXcgUHJvamVjdCBJZCA6IFwiLCBuZXdQcm9qZWN0Ll9pZCk7XHJcbiAgICAgICAgYXNzb2NpYXRlZFByb2plY3RJZCA9IG5ld1Byb2plY3QuX2lkO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzUgLSBhc3NvY2lhdGVkUHJvamVjdElkIDpcIiwgYXNzb2NpYXRlZFByb2plY3RJZCk7XHJcbiAgICAgICAgcmV0dXJuIGhlbHBlcnMubmV4dE9jY3VycmVuY2UoY2xlYW5PYmplY3QsIGluc3RhbmNlKTtcclxuICAgICAgfSlcclxuICAgICAgLnRoZW4oKGRlYWRsaW5lKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCIjMTQgLSBOZXh0IE9jY3VyYW5jZSBSZXR1cm5lZDogXCIsIGRlYWRsaW5lKTtcclxuICAgICAgICBuZXdQcm9qZWN0LnNldHVwLmR1ZURhdGUuYWN0dWFsID0gZGVhZGxpbmU7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCIjMTUgLSBOZXcgUHJvamVjdCBEZWFkbGluZSBTZXQgOiBcIiwgbmV3UHJvamVjdC5zZXR1cC5kdWVEYXRlLmFjdHVhbCk7XHJcbiAgICAgICAgcmV0dXJuIGhlbHBlcnMuZ2V0VGFza0FycmF5KHRlbXBsYXRlSWQpO1xyXG4gICAgICB9KVxyXG4gICAgICAudGhlbigoYXJyYXlvZklkcykgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiIzE3IC0gUmV0dXJuZWQgRnJvbSBUYXNrIEFycmF5IEhlbHBlciBcIiwgYXJyYXlvZklkcyk7XHJcbiAgICAgICAgLy9mb3IgZXZlcnkgaWQsIG1ha2UgYSBuZXcgcHJvamVjdCB0YXNrXHJcbiAgICAgICAgdmFyIG5ld190YXNrc19wcm9taXNlcyA9IF8ubWFwKGFycmF5b2ZJZHMsIGZ1bmN0aW9uKGlkKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhcIkFycmF5IG9mIElkcyBJRCBcIiwgaWQpO1xyXG4gICAgICAgICAgcmV0dXJuIGhlbHBlcnMubWFrZVRlbXBsYXRlVGFza09iamVjdChpZCwgYXNzb2NpYXRlZFByb2plY3RJZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy9uZXdfdGFza3NfcHJvbWlzZXMgbm93IGNvbnRhaW5zIGFuIGFycmF5IG9mIHByb21pc2VzIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgYXMgZWFjaCBvZiB0aGUgdGFza3MgYXJlIGNyZWF0ZWRcclxuICAgICAgICBjb25zb2xlLmxvZyhcIiMxOSAtIEFycmF5IG9mIE5ldyBUYXNrIFByb21pc2VzXCIsIG5ld190YXNrc19wcm9taXNlcyk7XHJcbiAgICAgICAgcmV0dXJuIFEuYWxsKG5ld190YXNrc19wcm9taXNlcyk7XHJcbiAgICAgIH0pXHJcbiAgICAgIC50aGVuKChjbGVhbl9vYmplY3RzKSA9PntcclxuICAgICAgICBjb25zb2xlLmxvZyhcIiMyMCAtIEFycmF5IG9mIE5ldyBUYXNrIE9iamVjdHNcIiwgY2xlYW5fb2JqZWN0cyk7XHJcbiAgICAgICAgcmV0dXJuIFEuYWxsKF8ubWFwKGNsZWFuX29iamVjdHMsIChjbGVhbl9vYmplY3QpID0+IHtcclxuICAgICAgICAgIHJldHVybiBoZWxwZXJzLm1ha2VQcm9qZWN0VGFzayhjbGVhbl9vYmplY3QsIGFzc29jaWF0ZWRQcm9qZWN0SWQpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgfSlcclxuICAgICAgLnRoZW4oKHByb2plY3RfdGFza3MpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIiMyMiAtIFByb2plY3QgVGFza3NcIiwgcHJvamVjdF90YXNrcyk7XHJcbiAgICAgICAgLy90YWtlIHRhc2tzLCBwdXQgaW4gUHJvamVjdCwgc2F2ZVxyXG4gICAgICAgIG5ld1Byb2plY3QuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb2plY3RfdGFza3MubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgIG5ld1Byb2plY3QudGFza3MucHVzaChwcm9qZWN0X3Rhc2tzW2ldKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbmV3UHJvamVjdC5zZXR1cC5hc3NvY2lhdGVkVGVtcGxhdGUgPSB0ZW1wbGF0ZUlkO1xyXG4gICAgICAgIG5ld1Byb2plY3Quc2F2ZSgpLnRoZW4oKHByb2plY3QpID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWFkZSBpdCFcIik7XHJcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocHJvamVjdCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcclxuICAgIH0sXHJcblxyXG4gICAgbmV3U2luZ2xlUHJvamVjdChyZXEsIHJlcykge1xyXG4gICAgICAgIGNvbnN0IG5ld1Byb2plY3QgPSBuZXcgUHJvamVjdChyZXEuYm9keSk7XHJcbiAgICAgICAgbmV3UHJvamVjdC5mcmllbmRseUlkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtsZW5ndGg6IDUsIHJlYWRhYmxlOiB0cnVlfSk7XHJcbiAgICAgICAgbmV3UHJvamVjdC5zYXZlKClcclxuICAgICAgICAudGhlbigocHJvamVjdCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLmpzb24ocHJvamVjdCk7XHJcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBuZXdUcmlnZ2VyZWRQcm9qZWN0KHJlcSwgcmVzKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCIjMSAtIE5ldyBQcm9qZWN0IEZ1bmN0aW9uIENhbGxlZFwiKTtcclxuICAgICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlcS5wYXJhbXMudGVtcGxhdGVpZDtcclxuICAgICAgICB2YXIgaW5zdGFuY2UgPSByZXEuYm9keS5pbnN0YW5jZTtcclxuICAgICAgICB2YXIgZGVzY3JpcHRpb24gPSByZXEuYm9keS5kZXNjcmlwdGlvbjtcclxuICAgICAgICB2YXIgYXNzb2NpYXRlZFByb2plY3RJZDtcclxuICAgICAgICB2YXIgbmV3UHJvamVjdDtcclxuICAgICAgICBoZWxwZXJzLm1ha2VQcm9qZWN0T2JqZWN0KHRlbXBsYXRlSWQpXHJcbiAgICAgICAgICAudGhlbigoY2xlYW5PYmplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMyAtIE1ha2UgUHJvamVjdCBPYmplY3QgUmV0dXJuZWQ6IFwiLCBjbGVhbk9iamVjdCk7XHJcbiAgICAgICAgICAgIG5ld1Byb2plY3QgPSBuZXcgUHJvamVjdChjbGVhbk9iamVjdCk7XHJcbiAgICAgICAgICAgIG5ld1Byb2plY3QuZnJpZW5kbHlJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7bGVuZ3RoOiA1LCByZWFkYWJsZTogdHJ1ZX0pO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIiM0IC0gTmV3IFByb2plY3QgSWQgOiBcIiwgbmV3UHJvamVjdC5faWQpO1xyXG4gICAgICAgICAgICBhc3NvY2lhdGVkUHJvamVjdElkID0gbmV3UHJvamVjdC5faWQ7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzUgLSBhc3NvY2lhdGVkUHJvamVjdElkIDpcIiwgYXNzb2NpYXRlZFByb2plY3RJZCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aW1lQ3RybC50cmlnZ2VyZWRQcm9qZWN0RGVhZGxpbmUoKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAudGhlbigoZGVhZGxpbmUpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMTQgLSBOZXh0IE9jY3VyYW5jZSBSZXR1cm5lZDogXCIsIGRlYWRsaW5lKTtcclxuICAgICAgICAgICAgbmV3UHJvamVjdC5zZXR1cC5kdWVEYXRlLmFjdHVhbCA9IGRlYWRsaW5lO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIiMxNSAtIE5ldyBQcm9qZWN0IERlYWRsaW5lIFNldCA6IFwiLCBuZXdQcm9qZWN0LnNldHVwLmR1ZURhdGUuYWN0dWFsKTtcclxuICAgICAgICAgICAgcmV0dXJuIGhlbHBlcnMuZ2V0VGFza0FycmF5KHRlbXBsYXRlSWQpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC50aGVuKChhcnJheW9mSWRzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzE3IC0gUmV0dXJuZWQgRnJvbSBUYXNrIEFycmF5IEhlbHBlciBcIiwgYXJyYXlvZklkcyk7XHJcbiAgICAgICAgICAgIC8vZm9yIGV2ZXJ5IGlkLCBtYWtlIGEgbmV3IHByb2plY3QgdGFza1xyXG4gICAgICAgICAgICB2YXIgbmV3X3Rhc2tzX3Byb21pc2VzID0gXy5tYXAoYXJyYXlvZklkcywgZnVuY3Rpb24oaWQpIHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFycmF5IG9mIElkcyBJRCBcIiwgaWQpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBoZWxwZXJzLm1ha2VUZW1wbGF0ZVRhc2tPYmplY3QoaWQsIGFzc29jaWF0ZWRQcm9qZWN0SWQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy9uZXdfdGFza3NfcHJvbWlzZXMgbm93IGNvbnRhaW5zIGFuIGFycmF5IG9mIHByb21pc2VzIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgYXMgZWFjaCBvZiB0aGUgdGFza3MgYXJlIGNyZWF0ZWRcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCIjMTkgLSBBcnJheSBvZiBOZXcgVGFzayBQcm9taXNlc1wiLCBuZXdfdGFza3NfcHJvbWlzZXMpO1xyXG4gICAgICAgICAgICByZXR1cm4gUS5hbGwobmV3X3Rhc2tzX3Byb21pc2VzKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAudGhlbigoY2xlYW5fb2JqZWN0cykgPT57XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzIwIC0gQXJyYXkgb2YgTmV3IFRhc2sgT2JqZWN0c1wiLCBjbGVhbl9vYmplY3RzKTtcclxuICAgICAgICAgICAgcmV0dXJuIFEuYWxsKF8ubWFwKGNsZWFuX29iamVjdHMsIChjbGVhbl9vYmplY3QpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gaGVscGVycy5tYWtlUHJvamVjdFRhc2soY2xlYW5fb2JqZWN0LCBhc3NvY2lhdGVkUHJvamVjdElkKTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC50aGVuKChwcm9qZWN0X3Rhc2tzKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiIzIyIC0gUHJvamVjdCBUYXNrc1wiLCBwcm9qZWN0X3Rhc2tzKTtcclxuICAgICAgICAgICAgLy90YWtlIHRhc2tzLCBwdXQgaW4gUHJvamVjdCwgc2F2ZVxyXG4gICAgICAgICAgICBuZXdQcm9qZWN0LmRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb247XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvamVjdF90YXNrcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgIG5ld1Byb2plY3QudGFza3MucHVzaChwcm9qZWN0X3Rhc2tzW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBuZXdQcm9qZWN0LnNhdmUoKS50aGVuKChwcm9qZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJNYWRlIGl0IVwiKTtcclxuICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24ocHJvamVjdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gIG9uZVByb2plY3QocmVxLCByZXMpIHtcclxuICAgIHZhciB0ZW1wbGF0ZU9wdGlvbnMgPSB7XHJcbiAgICAgIHBhdGg6ICd0YXNrcycsXHJcbiAgICAgIG1vZGVsOiAnUHJvamVjdFRhc2snLFxyXG4gICAgICBwb3B1bGF0ZToge1xyXG4gICAgICAgIHBhdGg6XCJhc3NpZ25tZW50LmVtcGxveWVlc1wiLFxyXG4gICAgICAgIG1vZGVsOiBcIkVtcGxveWVlXCIsXHJcbiAgICAgICAgc2VsZWN0OiBcImlkZW50aWZpY2F0aW9uLm5hbWUuZnVsbE5hbWVcIlxyXG4gICAgIH1cclxuICAgIH1cclxuICAgIFByb2plY3QuZmluZEJ5SWQocmVxLnBhcmFtcy5pZCkucG9wdWxhdGUodGVtcGxhdGVPcHRpb25zKS5leGVjKCkudGhlbigocmVzdWx0KSA9PiB7XHJcbiAgICAgIHJldHVybiByZXMuanNvbihyZXN1bHQpO1xyXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgZWRpdFByb2plY3QocmVxLCByZXMpIHtcclxuICAgIFByb2plY3QudXBkYXRlKHtfaWQ6IHJlcS5wYXJhbXMuaWR9LCByZXEuYm9keSkudGhlbigoKSA9PiB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuZW5kKCk7XHJcbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9LFxyXG5cclxuICBkZWxldGVQcm9qZWN0KHJlcSwgcmVzKSB7XHJcbiAgICBQcm9qZWN0LnJlbW92ZSh7X2lkOiByZXEucGFyYW1zLmlkfSwgcmVxLmJvZHkpLnRoZW4oKCkgPT4ge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmVuZCgpO1xyXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSxcclxuXHJcblxyXG4gIGFsbFByb2plY3RzKHJlcSwgcmVzKSB7XHJcbiAgICBQcm9qZWN0LmZpbmQoKS5wb3B1bGF0ZSgndGFza3MnKS5leGVjKCkudGhlbigocmVzdWx0KSA9PiB7XHJcbiAgICAgIHJldHVybiByZXMuanNvbihyZXN1bHQpO1xyXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufTtcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
